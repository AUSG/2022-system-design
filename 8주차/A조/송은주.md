### 10장 : 알림 시스템 설계

이번장의 목표 : iOS/안드로이드 푸시 알림, SMS 메시지, 이메일을 지원하는 알림 시스템의 개략적 설계안을 그려보는 것 

1. 알림유형별 지원방안을 파악한다.
- iOS / 안드로이드 푸시 알림 : 알림 제공자, APNS/FCM, iOS 단말/안드로이드 단말
	
    - 알림 제공자 : 알림요청을 만들어서 APNS로 보내는 주체
    	- 알림요청 : 단말토큰 (알림요청 보내는데 필요한 고유 식별자)
        
       - 페이로드 : 알림내용을 담은 JSON 딕셔너리 
	
    - APNS : 애플푸시 알림 서비스로, 푸시 알림을 iOS 장치로 보내는 역할
    - iOS 단말 : 푸시 알림을 수신하는 사용자 단말
 
- SMS 메시지 : 제3사업자의 서비스 이용  
- 이메일 : 상용 이메일 서비스 or 고유 이메일 서버 구축

<개략적 설계안>
![](https://velog.velcdn.com/images/eunz_juu/post/2ddc3da3-e429-4924-8d31-c2bc739ee47c/image.png)
- 제 3의 서비스는 사용자에게 알림을 실제로 전달하는 역할을 하며, 제3자 서비스와의 통합을 진행할 때는 `확장성` 을 고려해야 한다 = 쉽게 새로운 서비스 통합 및 기존 서비스 제거가 가능해야 한다.
ex) 중국에서는 FCM을 사용할 수 없으므로 제이푸시와 같은 다른 서비스를 사용해야 함

- 이 설계의 문제점
  1. SPOF : 알림 시스템 서버가 1개뿐
  2. 규모 확장성 : 한대의 서비스로 푸시 알림과 관련된 모든 것을 처리하니까, DB나 캐시 등 중요 컴포넌트 규모를 개별적으로 늘릴 방법이 없다.
  3. 성능 병목 : 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업이므로, 한 서버로 처리하면 사용자 트래픽이 몰려 과부하 상태가 될 수 있음

<개선된 개략적 설계안>
- DB와 캐시를 알림 시스템의 **주 서버에서 분리**
- **알림 서버를 증설**하고 자동으로 수평적 규모 확장이 이루어지도록
- **메시지 큐**를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊음

![](https://velog.velcdn.com/images/eunz_juu/post/25f69572-c373-4260-807c-21bcd4875184/image.png)
- 알림 서버 : 알림 서버는 알림 데이터를 메시지 큐에 넣는데, 이 설계안의 경우 하나 이상의 메시지 큐를 사용하므로 **병렬** 처리가 가능
- 캐시 : 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시
- 메시지 큐 : 시스템 컴포넌트 간 _**의존성을 제거**_하려고 사용, 다량의 알림 전송되어야 하는 경우를 대비한 버퍼 역할
	
    - 알림 시스템은 제3자 서비스에 의존성을 갖게 되고, 제 3자서비스에 장애가 발생하면 알림 서버가 보내는 알림데이터가 유실될 수 있음
    - 메시지큐가 들어가면 제 3자 서비스가 죽더라도 알림 시스템이 보내는 알림은 큐에 저장되기 때문에 정상적인 요청이 가능하다

> **3단계**

- **안정성**
	
    - 데이터 손실 방지 : 알림데이터를 DB에 보관하고, 재시도 메커니즘을 구현해야 한다. 
    ex) 알림 로그 DB 유지
    - 알림 중복 전송 방지 : 같은 알림이 여러번 반복되는 것을 막는다. 알림도착 시 이벤트ID를 검사하여 본 적 있는 이벤트인지 살피고, 중복된 경우 버림

- **추가로 필요한 컴포넌트**
	
    - 알림 템플릿 : 인자나 스타일, 추적 링크를 조정하기만 하면 사전에 `지정한 형식`에 맞춰 알람을 만들어내는 틀 / 전송될 알림형식을 일관성 있게 유지 가능하며 알림 작성에 드는 시간 절약
    - 알림설정 테이블에 알림 설정 항목 저장
    - 전송률 제한 : 한 사용자가 받을 수 있는 알림 빈도 제한
    - 재시도 방법 : 제 3자 서비스가 알림전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣음
    - 푸시 알림과 보안 : iOS, 안드로이드의 경우 알림 전송 API가 appKey와 appSecret을 사용하여 보안을 유지함. 따라서 인증된 클라이언트만 알림 전송 가능
   - 큐 모니터링 : 알림 시스템을 모니터링 할 때 큐에 쌓인 알림 개수를 보고, 그에 맞게 작업 서버 증설
   - 이벤트 추적 : 클릭율, 알림 확인율과 같은 이벤트를 추적하고 데이터를 분석하는 서비스와 통합

![](https://velog.velcdn.com/images/eunz_juu/post/60d40ab0-c75c-4d5c-b967-be840bfeb7c9/image.png)
- 재시도 기능 추가
- 전송 템플릿을 사용하여 알림 생성 과정 단순화
- 모니터링, 추적 시스템 추가
    
> **4단계**

1. 안정성 : 메시지 전송 실패율 낮추기 위해, 안정적인 재시도 메커니즘 도입
2. 보안 : 인증된 클라이언트만 알림 전송하도록 appKey, appSecret 사용
3. 이벤트 추적 및 모니터링 : 알림 생성 후 전송까지의 과정 추적, 시스템 상태 모니터링하기 위해 알림전송의 각 단계마다 이벤트를 추적하고 모니터링하는 시스템 통합
4. 사용자 설정 : 사용자가 알림 수신 설정 조정
5. 전송률 제한 : 사용자에게 알림 전송 빈도를 제한