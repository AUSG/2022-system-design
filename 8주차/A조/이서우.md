# < 10장 알림 시스템 설계 >

알림시스템 (notification system)을 갖춘 애플리케이션
<br> -> 최신뉴스, 제품 업데이트, 이벤트, 선물 등 고객에게 중요할 만한 정보를 비동기적으로 제공

# 알림 유형별 지원 방안

## ios 푸시 알림

![KakaoTalk_20221108_171617417](https://user-images.githubusercontent.com/78267146/200510953-ef73b776-7477-42cc-a25d-535b30377eb8.jpg)

- ios에서 푸시 알림을 보내기 위해선 세 가지 컴포넌트가 필요
- 알림 제공자(provider): 알림 요청(notification request)를 만들어 APNS로 보낸다. 알림 요청을 만들려면 (1)알림 요청을 보내는 데 필요한 고유 식별자인 "device token", (2) 알림 내용을 담은 JSON 딕셔너리인 "페이로드"가 필요
- APNS(Apple Push Notification Service): 애플이 제공하는 원격 서비스. 푸시 알림을 iOS 장치로 보내는 역할 담당
- ios 단말(ios device): 푸시 알림을 수신하는 사용자 단말

## 안드로이드 푸시 알림

![KakaoTalk_20221108_171617417_01](https://user-images.githubusercontent.com/78267146/200510990-69856bae-539b-4cbe-b2f1-f875a0f1db35.jpg)

- APNS 대신 FCM(Firebase Cloud Messaging)을 사용한다는 점만 다르다

## SMS 메세지

![KakaoTalk_20221108_171617417_02](https://user-images.githubusercontent.com/78267146/200511238-192427ab-d6ba-4f80-bfd1-b4faf0b58949.jpg)

- 보통 트윌리오, 넥스모 같은 제 3 사업자의 서비스를 많이 이용

## 이메일

![KakaoTalk_20221108_171617417_03](https://user-images.githubusercontent.com/78267146/200511250-c8010f02-81e1-4409-8294-9168c45d3aea.jpg)

- 많은 회사가 센드그리드, 메일침프같은 상용 이메일 서비스를 이용
- 대부분의 회사는 고유 이메일 서버를 구축할 역량은 갖추고 있지만, 상용 이메일 서버를 사용하는 것이 전송 성공률도 높고, 데이터 서비스도 제공

# 연락처 정보 수집 절차

![KakaoTalk_20221108_171617417_04](https://user-images.githubusercontent.com/78267146/200511521-141ab870-7060-4cd5-91cd-db229dc48aa2.jpg)

- 알림 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요
- 앱을 설치하거나 처음으로 계정을 등록 -> API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장
- 데이터베이스에 연락처 정보를 저장할 테이블 구조 ( 한 사용자가 여러 단말을 가질 수 있다)
  ![KakaoTalk_20221108_171617417_05](https://user-images.githubusercontent.com/78267146/200511351-c82125a5-8822-4684-84f1-5775b88b4656.jpg)

# 알림 전송 및 수신 절자

## 개략적 설계안 (초안)

![KakaoTalk_20221108_172205888](https://user-images.githubusercontent.com/78267146/200512097-07b522b1-b362-4416-9724-12c432e8c2d9.jpg)

- 1~N 까지의 서비스 : 이 서비스 각각은 마이크로서비스 or 크론잡 Or 분산시스템 컴포넌트일 수도 있다 ex) 사용자에게 납기일을 알리는 서비스, 배송알림 보내는 쇼핑몰
- 알림 시스템(notification system) : 알림 전송/수신처리의 핵심. 1개 서버만 사용하는 시스템이라면 서비스 N개에 알림 전송을 위한 API 제공해야 함. 제 3자 서비스에 전달할 알림 페이로드를 만들어 낼 수 있어야 함
- 제 3자 서비스 (third party service): 이 서비스들은 사용자에게 알림을 실제로 전달하는 역할. 고려할 점 (1)"확장성(쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어햐)" (2) FCM이 중국에서 사용 불가능 한 것처럼 어떤 서비스는 다른 시장에서 사용 할 수 X
  -ios, 안드로이드, SMS, 이메일 단말 : 사용자는 자기 단말에서 알림을 수신

## 이 설계의 문제점

- SPOF(Single-Point-Of-Failure): 알림 서버에 서버 1개 -> 그 서버에 장애 -> 전체 서비스의 장애
- 규모 확장성: 한 대 서비스로 푸시알림 관련 다 처리 -> 컴포넌트 규모를 개별적으로 늘릴 방법이 X
- 성능병목 : 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업 -> 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에 시스템 과부하 상태

## 개략적 설계안 (개선된 버전)

### 개선된 점

- 데이터베이스와 캐시를 알림 시스템 주 서버에서 분리
- 알림 서버를 증설하고 자동으로 수평적 규모 확장 이루어질 수 있도록
- 메세지 큐 이용 -> 시스템 컴포넌트 사이의 강한 결합 끊음
  ![KakaoTalk_20221108_171617417_07](https://user-images.githubusercontent.com/78267146/200511529-b4583977-db92-439a-bf76-036918414639.jpg)
- 1~N 서비스 : 알림 시스템 서버의 API를 통해 알림을 보낼 서비스들
- 알림 서버
  - 알림 전송 API : 사내서비스 또는 인증된 클라이언트만 이용 가능
  - 알림 검증 : 이메일 주소, 전화번호 등에 대한 기본적 검증 수행
  - 데이터베이스 또는 캐시 질의 : 알림에 포함시킬 데이터를 가져오는 기능
  - 알림 전송 : 알림 데이터 -> 메세지 큐에 넣는다. 하나 이상의 메세지 큐 사용하면 알림 병렬처리 가능
- 캐시 : 사용자 정보, 단말 정보, 일반 템플릿 등을 캐시한다
- 데이터베이스 : 사용자, 알림,설정 등 다양한 정보를 저장한다
- 메세지 큐 : 시스템 컴포넌트 간 의존성을 제거하기 위해 사용. 다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할. 제 3자 서비스 가운데 하나에 장애 발생해도 다른 종류의 알림은 정상 동작
- 작업 서버 : 메세지 큐 -> 제 3자 서비스로 알림 전달

### 알림 전송 과정

1. API 호출해 알림 서버로 알림 보냄
2. 알림서버는 사용자 정보 등등을 캐시나 데이터베이스에서 가져온다
3. 알림 서버는 전송할 알림에 맞는 이벤트 만들어 해당 이벤트를 위한 큐에 넣음. (ios 푸시 알림 이벤트는 ios 푸시알림 큐에 넣음)
4. 작업 서버 : 메세지 큐에서 알림 이벤트 꺼낸 후 제 3 자 서비스로 보냄
5. 제 3자 서비스 : 사용자 단말로 알림 전송

# 안정성

분산 환경에서 운영될 알림 시스템 설계 -> 안정성을 확보하기 위한 사항 몇가지를 반드시 고려해야 한다

## 데이터 손실 방지

- 알림 전송 시스템의 가장 중요한 요구사항 중 하나는 알림이 절대 소실되면 안된다는 것
- 따라서 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다 -> 알림 로그 데이터베이스를 유지하는 것이 한가지 방법

## 알림 중복 전송 방지

- 중복 완전 방지는 불가능. 중복 빈도를 줄여야한다
- 보내야 할 알림이 도착하면 그 이벤트ID를 검사해 이전에 본 적 있는 이벤트인지 살핀다

# 추가로 필요한 컴포넌트 및 고려사항

## 알림 템플릿

- 알림 메세지는 대부분 형시기이 비슷하므로 알림 템플릿은 알림 메세지의 모든 부분을 처음부터 다시 만들 수 없도록 해 준다.
- 인자나 추적링크를 조정하기만 하면 사전에 지정한 형식에 맞춰 알림을 만들어 낼 수 있다

## 알림 설정

- 많은 웹사이트와 앱에서는 사용자가 알림설정을 상세히 조정할 수 있도록 한다
- 이 정보는 알림 설정 테이블에 보관된다
  - user id, channel(알림이 전송될 채널: 푸시, 이메일 등), opt_in(해당 채널로 알림을 받을지 여부)

## 전송률 제한

- 한 사용자가 받을 수 있는 알림의 빈도를 제한

## 재시도 방법

- 제 3자 서비스가 알림 전송에 실패하면 해당 알림을 재시도 전용 큐에 넣는다

## 푸시 알림과 보안

- ios, 안드로이드 : appKey아 appSecret을 사용해 보안 유지 -> 인증되거나 승인된 클라이언트만 해당 API 이용해서 알림 보낼 수 있음

## 큐 모니터링

- 큐에 쌓인 알림의 개수가 너무 크면 작업 서버들이 이벤트를 빠르게 처리하고 있지 못하다는 뜻 -> 작업 서버를 증설하는게 바람직

## 이벤트 추적

- 데이터 분석 서비스는 보통 이벤트 추적 기능도 제공함 -> 보통 알림 시스템을 만들면 데이터 분석 서비스와도 통합해야만 한다

# 수정된 설계안

![KakaoTalk_20221108_171617417_08](https://user-images.githubusercontent.com/78267146/200511537-0e9ddeb1-2f32-4531-b454-ef0b7a1e9496.jpg)

- 알림 서버에 인증, 전송률 제한 기능이 추가
- 전송 실패에 대응하기 위한 재시도 기능 추가. 전송 실패한 알림을 다시 큐에 넣고 지정된 횟수만큼 재시도
- 전송 템플릿을 사용 -> 알림 생성 과정을 단순화하고 알림 내용의 일관성 유지
- 모니터링 & 추적 시스템 추가 -> 시스템 상태를 확인하고 추후 시스템을 개선하기 쉽도록 함
