# < 1장 사용자 수에 따른 규모 확장성 >

## 단일서버

- 모든 컴포넌트가 단 한대의 서버에서 실행되는 간단한 시스템
- 웹 앱, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행된다
- 사용자 요청 처리 흐름
  <br> (1) 도메인 이름을 DNS에 질의해 IP 주소로 변환
  <br> (2) 해당 IP주소로 HTTP 요청 전달
  <br> (3) 요청 받은 웹 서버는 HTML페이지나 JSON 형태의 응답 반환
- 요청이 오는 곳 : (1) 웹 앱 (2) 모바일 앱
  <br>

## 데이터베이스

- 웹/모바일 트래픽 처리 서버(웹 계층)와 데이터베이스 서버(데이터 계층)을 분리하면 그 각각을 독립적으로 확장해 나갈 수 있다

### 관계형 데이터 베이스 (RDBMS)

- MySQL, 오라클데이터베이스, PostgreSQL
- 테이블과 열, 칼럼으로 표현
- 여러 테이블에 있는 데이터를 그 관계에 따라 조인 가능

### 비 관계형 데이터 베이스 (NoSQL)

- CouchDB, Neo4j, Cassandra, HBase, Amazon DynamoDB
- 키-값 저장소, 그래프 저장소, 칼럼 저장소, 문서 저장소 4가지로 나눌 수 O
- 조인 연산 X

### 비 관계형 데이터 베이스가 더 좋은 경우

- 아주 낮은 응답 지연시간이 요구됨
- 다루는 데이터가 비정형
- 데이터(Json, Yaml, Xml 등)를 직렬화하거나(serialize) 역직렬화(deserialize) 할 수 있기만 하면 됨
- 아주 많은 양의 데이터를 저장할 필요가 있음
  <br>

## 수직적 규모 확장 VS 수평적 규모 확장

### 수직적 규모 확장

- 서버에 고사양 자원 (더 좋은 CPU, 더 많은 RAM)을 추가하는 행위
- 서버로 유입되는 트래픽의 양이 적을 때 좋음
- 한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법X
- 자동복구 방안이나 다중화 방안을 제시하지 X, 서버에 장애가 발생하면 웹사이트/앱은 완전히 중단된다

### 수평적 규모 확장

- 더 많은 서버를 추가하여 성능을 개선하는 행위
- 대규모 어플리케이션을 지원하는데 적절

### 로드밸런서

- 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할
- 사용자는 로드밸런서의 공개 IP 주소로 접속 -> 서버 간 통신에는 사설 IP 주소( 같은 네트워크에 속한 서버 사이의 통신에만 쓰일 수 있는 IP 주소, 인터넷을 통해서 접속 불가능)가 이용된다.

### 데이터베이스 다중화

- 서버 사이에 주(master)-부(slave) 관계를 설정학 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식
- 쓰기 연산은 주(master)에만 지원, 부 데이터베이스는 읽기 연산만 지원
- 부 데이터베이스의 수(읽기 연산) > 주 데이터베이스의 수(쓰기 연산)
- 이점 : 더 나은 성능, 안정성, 가용성

### 로드밸런서와 데이터베이스 다중화를 고려한 설계안

![img]()
<br>

## 캐시

- 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤 이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소

### 캐시 계층

- 데이터가 잠시 보관되는 곳, 데이터베이스보다 훨씬 빠르다
- 읽기 주도형 캐시 전략 : 요청을 받은 웹 서버는 캐시에 응답이 저장되어 있는지를 보고, 저장되어 있다면 해당 데이터를 클라에 반환, 없는 경우 데이터베이스 질의를 통해 테이터를 찾아 캐시에 저장한 후 클라에 반환

### 캐시 사용시 유의점

- 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어날 때 캐시 사용
- 중요 데이터를 캐시에 두는 것은 바람직하지 X
- 캐시에 보관된 데이터 만료에 대한 정책을 마련해 두는 것이 좋은 습관
- 일관성 유지, 장애대처, 캐시 메모리 크기, 데이터 방출 정책 등도 고려해야한다

<br>

## 콘텐츠 전송 네트워크(CDN)

- 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크. 이미지, 비디오, CSS, Javascript파일 등을 캐시할 수 O
- CND 동작 방법
  <br> (1) 사용자가 URL을 이용해 image에 접근한다
  <br> (2) CDN서버의 캐시에 해당 이미지가 없는 경우, 서버는 원본 서버(웹 서버, AWS S3등) 에 요청하여 파일을 가져온다
  <br> (3) 원본서버가 파일을 CDN서버에 반환한다. 그때 헤더에는 파일이 얼마나 오래 캐시될 수 있는지 설명하는 TTL 값 들어있다
  <br>(4) CDN서버는 파일을 캐시하고 사용자 A에게 반환한다
  <br>

## 무상태(stateless) 웹 계층

- 무상태 웹 계층 : 상태 정보(사용자 세션 데이터와 같은)를 관계형 데이터베이스나 NoSQL 같은 지속성 저장소에 보관하고, 필요할 때 가져오도록 하는 것

### 상태 정보 의존적인 아키텍쳐

- 문제점 : 같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 한다는 것

### 무상태 아키텍처

- 사용자로부터의 HTTP 요청은 어떤 웹 서버로도 전달될 수 있다. 웹 서버는 상태 정보가 필요한 경우 공유 저장소로부터 데이터를 가져온다. 따라서 상태정보는 웹 서버로부터 물리적으로 분리되어 있다
  <br>

## 데이터 센터

- 지리적 라우팅(geoDNS-routing) : 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내된다
- 데이터 센터 중 하나에 심각한 장애가 발생하면 모든 트래픽은 장애가 없는 데이터 센터로 전송된다
  <br>

## 메세지 큐

- 메세지의 무손실(메시지 큐에 일단 보관된 메세지는 소비자가 꺼낼 때 까지 안전히 보관된다는 특성)을 보장하는, 비동기 통신을 지원하는 컴포넌트
- 메세지의 버퍼 역할을 하며, 비동기적으로 전송
- 메세지 큐의 기본 아키텍처 : 생산자 또는 발행자라고 불리는 입력 서비스가 메세지를 만들어 메세지 큐에 발행-> 큐에는 보통 소비자 혹은 구독자라 불리는 서비스 혹은 서버가 연결되어 메세지를 받아 그에 맞는 동작을 수행하는 역할
- 서비스 또는 서버 간 결합이 느슨해져서, 규모 확장성이 보장되어야하는 안정적 애플리케이션을 구성하기 좋다
  <br>

## 로드, 메트릭 그리고 자동화

- 로그 : 시스템의 오류와 문제들을 보다 쉽게 찾아낼 수 있도록 하기 때문에 에러 로그를 모니터링하는 것은 중요
- 메트릭 : 메트릭을 잘 수집하면 사업 현황에 관한 유용한 정보를 얻을 수도 있고, 시스템의 현재 상태를 손쉽게 파악할 수도 있다.
  <br> (1) 호스트 단위 메트릭: CPU, 메모리, 디스크 I/O에 관한 메트릭
  <br> (2) 종합 메트릭 : 데이터베이스 계층의 성능, 캐시 계층의 성능 같은 것
  <br> (3) 핵심 비즈니스 메트릭 : 일별 능동 사용자, 수익, 재방문 같은 것이 여기 해당
- 자동화 : 지속적 통합을 도와주는 도구를 활용하거나 빌드, 테스트, 배포 등의 절차를 자동화 할 수 있어서 개발 생산성을 크게 향상시킬 수 있다
  <br>

## 데이터베이스의 규모 확장

### 수직적 혹장 = 스케일 업

- 기존 서버에 더 맣은, 또는 고성능의 자원을 증설하는 방법이다.
- 단점
  <br>(1) 데이터베이스 서버 하드웨어에는 한계가 있으므로 CPU, RAM 등 무한 증설 불가능 -> 사용자가 계속 늘어나면 한 대 서버로는 결국 감당 하기 어렵다
  <br>(2) SPOF로 인한 위험성이 크다
  <br>(3) 비용이 많이 든다

### 수평적 확장 = 샤딩(sharding)

- 더 많은 서버를 추가함으로서 성능 향상 시킬 수 있다
- 샤딩은 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기술을 일컫는다.
- 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에느 중복이 없다
- 샤딩 전략을 구현할 때 고려해야 할 가장 중요한 것: 샤딩 키를 어떻게 정하느냐 -> 데이터가 어떻게 분산될지 정하는 하나 이상의 칼럼으로 구성된다

<br>
