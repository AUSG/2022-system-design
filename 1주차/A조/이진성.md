### Table of contents
- [Table of contents](#table-of-contents)
- [단일 서버](#단일-서버)
- [데이터베이스](#데이터베이스)
- [수직적 규모 확장 vs 수평적 규모 확장](#수직적-규모-확장-vs-수평적-규모-확장)
- [로드밸런서](#로드밸런서)
- [데이터베이스 다중화](#데이터베이스-다중화)
- [캐시](#캐시)
- [CDN(Content Delivery Network)](#cdncontent-delivery-network)
- [stateless 계층](#stateless-계층)
- [데이터센터](#데이터센터)
- [메세지 큐](#메세지-큐)
- [로그, 메트릭 그리고 자동화](#로그-메트릭-그리고-자동화)
- [데이터베이스 규모 확장](#데이터베이스-규모-확장)

### 단일 서버

일반적인 HTTP 서버에 대해서 설명한다 두 가지 종류의 클라이언트가 있고, DNS질의 과정과 HTTP통신을 통해 서버와 상호작용한다.

### 데이터베이스

- 웹 계층과 데이터 계층을 분리하면 그 각각을 독리적으로 확장해나갈 수 있다.
- 데이터베이스의 종류
    - 관계형 데이터베이스
        - 자료를 테이블과 열, 칼럼으로 표현한다.
        - SQL을 사용하면 여러 테이블에 있는 데이터를 그 관계에 따라 조인하여 합칠 수 있다.
    - 비-관계형 데이터베이스
        - 일반적으로 조인 연산은 지원하지 않음
        - 종류
            - 키 값 저장소
            - 그래프 저장소
            - 칼럼 저장소
            - 문서 저장소
- 데부분은 관계형 데이터베이스가 최선이다.
    - 하지만 laytency, 비정형 데이터, 단순한 저장, 적은 데이터 저장 등의 특수 목적에 따라서 달라지낟

### 수직적 규모 확장 vs 수평적 규모 확장

- scale up(vertical scaling) : 더 고사양 자원을 추가하는 행위
    - 트래픽 양이 적을 때 좋음, 단순함이 장점
    - 한 대의 서버의 자원 확장은 한계가 있고, 자동 복구(failover) 와 다중화(redudancy)를 제시하진 않음.
- scale out(horizental scaling) : 더 많은 서버를 추가하여 성능 개선
    - 대규모 어플리케이션은 수평적 규모 확장이 보다 적절함

### 로드밸런서

- 부하 분산 집합(load balancing set)에 속한 서버에게 트래픽을 고르가 분산하는 역할
- 보안을 위해 서버 간에는 사설 네트워크에서 통신하게 됨
- no failover 해소와 availability가 향상됨 - 노드의 추가/삭제를 통해 수평적 확장이 가능하고 fail 노드의 트래픽을 다른 노드에 전달하기만 하면 되기 떄문

### 데이터베이스 다중화

- 보통 master-slave 관계를 설정하고 사본을 slave 서버에 저장하는 방식으로 다중화가 가능함
    - write연산은 마스터에서만 지원
    - slave는 read 서버에서만 지원
    - 통상 slave노드가 더 많음
- 더 나은 성능 : 읽기 연산을 병렬로 처리가 가능하여, 처리량이 좋아짐
- 안정성(reliability) : 서버 중 일부가 파괴되어도 보존시킬 수 있음
- 가용성(availbility) : 하나의 데이터베이스의 장애가 발생해도 다른 서버에서 가져와 계속 서비스 가능
    - slave 서버가 죽어도 다른 slave서버들로 부하가 분산됨
    - master 서버가 죽어도 slave 서버 중 하나가 master 서버로 동작하여 서비스가 계속 될 수 있음
        - 단 불일치 문제가 발생할 수 있는데 recovery script를 돌리거나, multi-masters, circular replication을 사용하며 어느정도 해소됨
### 캐시

- 데이터가 잠시 보관되는 곳으로 데이터베이스(RDBMS)보다 훨씬 빠르다.
- 읽기 주도형 캐시 전략 : 캐시 확인 후 없으면 질의 및 저장
- 적절한 상황
    - 갱신보다 참조가 많은 경우
    - 영속적이지 않은 데이터
    - 적절한 만료 시간 : 많고 적음에 따라서 잦은 질의나 비일관성 문제가 드러남
    - 일관성유지 : 원본과 사본이 단일 트랜잭션으로 처리되지 않음 → 여러 지역에 확장할 경우 이러한 문제가 심각
    - 캐시도 단일 실패 지점이 될 수 있다! aka. SFOP
    - 캐시 메모리의 크기는 어떻게 잡을지 - 방출(eviction)이 발생하고 이를 해결할 수 있는 방법은 과할당(overprovision)이다.
    - 방출 정책(eviction) - LRU(최근 사용 기준), LFU(사용 빈도 기준), FIFO(먼저 들어온 캐시를 내보냄)

### CDN(Content Delivery Network)

- 정적 콘텐츠 전송에 쓰이는 지리적 분선 서버 네트워크이다.
- 동적 콘텐츠 캐싱 → 요청 경로, 질의 문자열, 쿠키, 요청헤더 등의 정보를 기반한 캐시
- 지리적으로 먼 원본 서버 대신 캐시서버가 받아 처리하는 것. 콘텐츠의 서빙 속도를 개선할 수 있음.
- 원리 자체는 `읽기 주도형 캐시 전략` 과 동일함
- 고려사항
    - 비용 : 비싸니까 자주 사용되지 않는 콘텐츠는 제거
    - 적절한 만료 시한 : 콘텐츠의 신선도와 관련 있음 짧지도 길지도 않게 설정해야함
    - CDN 장애시 대처 방안 필요 - 애플리케이션 로직에 fallback(origin) 콘텐츠 서버를 설정하거나 로컬캐시를 이용할 수도?
    - 콘텐츠 무효화 : invalidation → 임의로 만료되지 않은 콘텐츠 제거.
        - 새로운 콘텐츠 이용을 위해선 invalidation도 좋지만 query param을 다르게 가져가서 회피할 수도 있음

### stateless 계층

- 웹(서버) 계층의 수평적 확장을 위해선 상태 정보를 웹 계층에서 제거해야 함.
- 일반적으로 stateful한 서버들이 띄어져 있고 로컬에 세션 정보를 저장하면 round robin과 같은 load balancing 정책에서 서버간 세션 공유가 되지 않아 요청을 거절하는 등의 문제가 발생함
    - 단순하게는 round robin이 아닌 sticky session과 같은 형태로 문제를 풀 수 있음
    - 다만 이는 로드 밸런서의 추가적인 부담을 주고, 서버를 추가하거나 삭제할 때 고르게 요청이 분산되지 않는 단점도 있음
- 이를 해결하기 위해선 상태 정보를 공유하는 데이터베이스를 분리하여 이를 사용하도록 하면 됨.

### 데이터센터

- muilti datacenter로 구성하는 것은 latency 측면이나 failover(availibilty) 측면에서도 좋다.
- 유저가 가까운 데이터센터로 접근하게 하는 것을 geo-routing, 지리적 라우팅이라고 부른다.
- Question?
    - 지리적으로 굉장이 먼 데이터 센터 상태 간 사용자 프로파일 공유는 어떻게 할 수 있을까?
        - 걍 jwt쓰는게 나을지도?
- 기술적 난제
    - 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 법을 찾아야. geo dns는 가까운 곳으로 보냄
        - ❓ :  특정 database가 장애 상황인 경우 다른 데이터센터로 어떻게 라우팅하지?
    - 데이터 동기화 : 데이터 센터간의 데이터베이스 동기화 문제가 발생할 수 있음. 여러 데이터센터를 걸쳐서 다중화하는 방식으로 해결함.
    - 테스트와 배포 : 여러 데이터센터를 걸쳐 배포하거나 테스트를 하는 것이 중요함.

### 메세지 큐

- 무손실(durability)를 보장하며 비동기 통신을 지원하는 컴포넌트.
- 메세지의 버퍼 역할이며 비동기적으로 전송함
- 생산자 혹은 발행자 (producer/publisher)가 메세지를 만들어 발행하고, 소비자 혹은 구독자 (consumer / subscriber)가 서버로 연결되어 이는데 이에 맞는 동작을 수행함.
- 규모 확장성이 보장되어야 하는 안정적인 애플리케이션을 구성하기 좋음
- 오래걸리는 작업들을 처리하는 것에도 괜찮음

### 로그, 메트릭 그리고 자동화

- 로그 : 시스템의 오류나 문제를 비교적 쉽게 찾아낼 수 있도록 함.
- 메트릭 : 잘 수집하면 사업 현황에 유용한 정보르 얻을 수 있고, 시스템의 현재 상태를 손쉽게 파악할 수 있음
    - host 단위 메트릭 : cpu, mem, io 등과 같음
    - 종합 메트릭 : 데이터 베이스의 계층의 성능, 캐시 계층의 성능 등
    - 비즈니스 메트릭 , DAU, Revenue, retention 등이 이에 해당함
- 자동화 : CI, CD, Test Automation 등의 내용

### 데이터베이스 규모 확장

- 수직적 확장 : 스케일 업이라고 부르는 방법은 고성능의 하드웨어로 증성하는 방법. stackoverflow는 1000만명/년 방문자를 하나의 master database로 커버했음
    - SPOF, 비용, 물리적 성능 향상 제한등의 문제가 있음
- 수평적확장
    - sharding이라고 부르는데, 더 많은 서버를 추가함으로써 성능 확장이 가능
    - shard : 데이터베이스를 shard라는 작은 단위로 분할하는 기술을 일컫음, 샤드간 중복은 없음
    - 샤딩 전략을 구현할 때 중요한 것은 sharding key를 무엇으로 할 것인가
        - sharding key is..
            - partition key라고 부르기도함.
            - 데이터가 어떻게 분산될지 정하는 하나 이상의 칼럼을 구성됨.
        - 샤딩 키를 고르게 분산하는 것이 가장 중요함.
        - 문제들
            - resharding을 어떻게 할까? → 특정 샤드에 몰려 샤드 소진(shard-exhaustion)이 발생할 수도 있음
            - celebrity : hospot-key probrem이라고 불리고, 특정 샤드에 질의가 집중되는 문제
            - 조인과 비정규화(join and de-normalization) : 샤드로 쪼개면 여러 샤드에 걸친 데이터를 조인하기 힘듬!! 데이터베이스를 비정규화하는 형태로 조인을 제거할 수는 있음