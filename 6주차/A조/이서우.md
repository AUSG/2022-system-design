# <7장 분산 시스템을 위한 유일 ID 생성기 설계>

## 1. 문제 이해 및 설계 범휘 확정

- ID는 유일해야 함
- ID는 숫자로만 구성돼야 함
- ID는 64비트로 표현될 수 있는 값이어야 함
- ID는 발급 날짜에 따라 정렬 가능해야 함
- 초당 10000개의 ID를 만들 수 있어야 함

## 2. 개략적 설계안 제시 및 동의 구하기

분산 시스템에서 유일성이 보장되는 ID를 만드는 방법은 여러가지다

### 다중 마스터 복제

- 데이터베이스의 auto_increament 기능 활용
- But, 다음 ID 값을 구할 때 1만큼 증가 X, 현재 사용 중인 데이터 베이스 서버의 수만큼 증가시킨다
- 문제점 : 여러 데이터 센터에 결처 규모 늘리기 어렵 / ID값이 시간의 흐름에 맞추어 커지도록 보장 불가 / 서버를 추가하거나 삭제할 때도 잘 동작하도록 만들기 어렵

### UUID

- 컴퓨터 시스템에 저장된느 정보를 유일하게 식별하기 위햔 128bit 수
- 충돌 가능성이 지극히 낮다
- 장점 : 서버 사이의 조율이 필요없으므로 동기화 이슈도 없고 서버가 자기가 쓸 ID를 알아서 만드는 구조이므로 규모 확장도 쉽다
- 단점 : ID가 128비트로 길고 시간 순으로 정렬할 수 없으며, 숫자 아닌 값이 포함될 수 있다

### 티켓 서버

- auto_createment 기능을 갖춘 데이터베이스 서버, 즉 티켓 서버를 중앙 집중형으로 하나만 사용하는 것
- 장점 : 유일성이 보장되고 숫자로만 구성된 ID, 구현하기 쉽다
- 단점 : 티켓 서버가 SPOF가 돼 이 서버에 장애가 발생하면 해당 서버를 이용하는 모든 시스템이 영향 받는다

### 트위터 스노플레아크 접근법

- 생성해야 하는 ID의 구조를 여러 절로 분할
- 사인 비트 : 1비트를 할당, 음수와 양수 구분
- 타임스탬ㅁ프 : 41비트 할당, 기원 시간 이후 몇 밀리초 경과했는지 나타내는 값
- 데이터 센터 ID : 5비트 할당, 따라서 32개 데이터센터를 지원
- 서버 ID : 5비트를 할당, 따라서 데이터 센터당 32개 서버를 사용
- 일련번호 : 12비트를 할당, 각 서버에서는 ID를 생성할 때마다 이 일련번호를 1만큼 증가시킨다. 이 값은 1 밀리초가 경과할 때마다 0으로 초기화된다

## 3. 상세 설계

- 트위터 스노플레이크 접근법을 사용
- 데이터 센터 ID와 서버 ID 는 시스템이 시작할 때 결정
- 타임스탬프나 일련번호는 ID 생성기가 돌고 있는 중에 만들어지는 값

### 타임스탬프

- 시간의 흐름에 따라 점점 더 큰 값 가지므로 결국 ID는 시간 순으로 정렬 가능하게 될 것이다
- 41비트로 표현할 수 있는 타임스탬프 최대값은 2의 41승 -1 밀리 초 = 69년에 해당한다. 이 ID 생성기는 69년 동안만 정상 동작하므로 69년이 지나면 기원 시각을 바꾸거나 ID 체계를 다른 것으로 이전하여야 한다.

### 일련번호

- 일련번호는 12비트이므로 4096개의 값 가질 수 있다
- 서버가 같은 밀리초 동안 하나 이상의 ID를 만들어낸 경우에만 0보다 큰 값 가진다

## 4. 마무리

- 우리는 유일성이 보장되는 ID 생성기 구현에 쓰일 수 있는 전략 4가지를 살펴 봄
  <br> ->모든 요구 사항을 만족하면서도 분산 환경에서 규모 확장이 가능했던 스노우플레이크 방식을 선택하였다
