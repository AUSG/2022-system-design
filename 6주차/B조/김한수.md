# 분산 시스템을 위한 유일 ID 생성기 설계 + URL 단축기 설계(tinyurl)

- [분산 시스템을 위한 유일 ID 생성기 설계 + URL 단축기 설계(tinyurl)](#분산-시스템을-위한-유일-id-생성기-설계--url-단축기-설계tinyurl)
  - [분산 시스템을 위한 유일 ID 생성기 설계](#분산-시스템을-위한-유일-id-생성기-설계)
    - [유일성이 보장되는 ID](#유일성이-보장되는-id)
    - [다중 마스터 복제(multi-master replication)](#다중-마스터-복제multi-master-replication)
    - [UUID](#uuid)
    - [티켓 서버](#티켓-서버)
    - [트위터 스노플레이크(snowflake) 접근법](#트위터-스노플레이크snowflake-접근법)
    - [마치며](#마치며)
  - [URL 단축기 기능 설계](#url-단축기-기능-설계)
    - [API 리디렉션(redirection)](#api-리디렉션redirection)
    - [URl 단축](#url-단축)
    - [해시 함수](#해시-함수)
    - [해시 후 충돌 해소](#해시-후-충돌-해소)
    - [base-62 변환](#base-62-변환)
    - [해시 후 충돌 해소 vs base-62 변환](#해시-후-충돌-해소-vs-base-62-변환)
    - [마치며](#마치며-1)

## 분산 시스템을 위한 유일 ID 생성기 설계

분산 시스템에서는 `auto_increment` 속성이 설정된 RDBMS 기본 키 정도로 커버가 되지 않는 경우가 존재한다.

이런 경우 필요한 것이 `유일 ID 생성기`인데, 이에 대해서 알아보자

### 유일성이 보장되는 ID

유일성이 보장되는 ID 형식에는 다음 것들이 존재한다. 이에 대해서 하나씩 알아보자

- `다중 마스터 복제`(multi-master replication)
- `UUID`(Universally Unique Identifier)
- `티켓 서버`(ticket server)
- `트위터 스노플레이크`(twitter snowflake) 접근법

### 다중 마스터 복제(multi-master replication)

이 접근법은 DB의 `auto_increment` 기능을 활용한는 것이다.
다만, 다음 ID를 구할 때 1만큼 증가시키는 것이 아니라 `k` 만큼 증가시킨다.

- `k` = `현재 사용중인 데이터베이스의 수`

이 접근법을 이용하면 데이터베이스 수를 늘리면 초당 생산 가능 ID 수도 늘릴 수 있다.

하지만 이 접근법에는 엄청난 단점이 존재하는데,

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵고
- ID의 유일성이 보장되겠지만, 그 값이 시간 흐름에 맞추어 커지도록 보장할 수 없으며
- 서버를 추가하거나 삭제할 때도 동작하도록 만들기 어렵다.

### UUID

`UUID`는 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128bit짜리 수이다.

이는 **중복될 가능성이 정말 희박한데**, 위키피디아에 따르면 중복 UUID가 1개 생길 확률을 50%로 끌어 올리려면 초당 10억 개의 UUID를 100년 동안 계속해서 만들어야한다고 한다.

UUID는 `2eec2761-3dd9-4b5a-b7e2-b0fdaf351131` 와 같은 형태를 띄고 서버 간 **조율없이 독립적으로 생성 가능하다**

UUID의 장/단점을 나열해보면 다음과 같다

- 장점
  - 단순하다, 서버 사이의 조율이 필요 없으므로 동기화 이슈도 없다
  - 독립적이므로 규모 확장이 쉽다
- 단점
  - 128비트로 길다
  - ID를 시간순으로 정렬할 수 없다
  - ID에 숫자(numeric)가 아닌 값이 포함될 수 있다

### 티켓 서버

`티켓 서버`(ticket server)는 단순하게 `auto_increment` 기능을 갖춘 데이터베이스 서버.
즉, 다음과 같이 티켓 서버를 중앙 집중형으로 하나만 사용하는 것이다.

![ticket-server](https://user-images.githubusercontent.com/72328687/197569934-198e3c06-45b1-4695-a83c-b4e1b3797a73.png)

- 장점
  - 숫자로만 구성된 ID를 만들 수 있으며, 유일성이 보장
  - 단순해서 구현하기 쉬움
- 단점
  - `SPOF`(Single Point Of Failure)가 됨. 이 이슈를 피하려면 티켓 서버를 여러 대 준비해야하는데, 이러면 데이터 동기화 같은 문제가 발생.

### 트위터 스노플레이크(snowflake) 접근법

 `스노플레이크`(snowflake)는 트위터에서 사용하는 독창적인 ID 생성 기법이다.

64bit이고, ID만으로 생성된 시간 순 정렬을 할 수 있는 특징이 있다.

![twitter-snowflake](https://user-images.githubusercontent.com/72328687/197569954-4cab7c19-acb5-4440-9a8f-237e346070a3.png)

스노플레이크는 위와 같은 형태인데, 이를 좀 더 자세하게 살펴보면 다음과 같다.

- `사인(sign) 비트`: 1비트를 할당하여 당장 쓰임새가 없지만 음수와 양수를 구별하는 데 사용할 수 있다.
- `타임스탬프(timestamp)`: 41비트를 할당. 기원 시각(epoch) 이후로 얼마나 시간이 경과했는지 나타내는 값이다. 기원 시각은 최초에 한 번 지정하고 변경해서는 안된다.
- `데이터센터 ID`: 5비트 할당. 2^5의 수를 표현할 수 있으므로, 32개의 데이터센터를 지원할 수 있다.
- `서버 ID`: 5비트 할당. 이 또한 데이터센터 ID와 같이 데이터센터당 32개의 서버를 사용할 수 있다.
- `일련번호`: 12비트 할당. 각 서버에서 ID를 생성할 때마다 이 일련번호를 1만큼 증가시킨다. **이 값은 1밀리초가 경과할 때마다 0으로 초기화된다**

여기도 한계점은 존재하는데, 위 형식 기준으로 `현재시간 - 기원 시간`으로 계산한 타임스탬프가 41비트를 넘어서면 더 이상 이 체계를 사용할 수 없기에 ID 체계를 다른 것으로 이전해야한다.

즉. 이 스노플레이크 접근법도 모든 걸 해결해줄 은탄환은 아니다.

**항상 운영에서의 트레이드 오프를 생각하여 시스템의 수명과 요구 성능에 따라 타임스탬프, 데이터센터 ID 등 각 영역의 크기를 조절하여 결정해야하는 것을 잊지 말자.**

### 마치며

면접에서 설계를 진행하고 시간이 조금 남았다면 다음과 같은 논의들을 추가로 해볼 수 있을 것 같다.

- `시계 동기화`(clock synchronization)
  - 위 설계안 들은 ID 생성 서버들이 전부 같은 시계를 사용한다고 가정했었다. 하지만 ID 생성 서버들이 여러 코어에서 실행될 경우 전부 같은 시계를 사용하지 않을 수 있는데, 물리적으로 독립된 여러 장비에서 실행될 경우에도 유효하지 않을 수 있다.
    이 문제의 보편적인 해결책으로는 `NTP`(Network Time Protocol)이 있다.
- `각 절(section)의 길이 최적화`
  - 위에서 살펴본 스노플레이크의 각 섹션의 길이를 조정하여 구현하고자하는 애플리케이션에 최적의 선택을 할 수 있다. 예를 들어 동시성이 낮고 수명이 긴 애플리케이션이라면 일련번호 섹션의 길이를 줄이고 타임스탬프 섹션의 길이를 늘려볼 수 있다.
- `고가용성(high availability)`
  - ID 생성기는 필수 불가결(mission critical) 컴포넌트이므로 아주 높은 가용성을 제공해야 한다.

## URL 단축기 기능 설계

tinyurl같은 URL 단축기는 고전적인 시스템 설계 문제 중 하나이다.

이 시스템의 기본적인 기능은 다음과 같다.

- URL 단축: 주어진 긴 URL을 훨씬 짧게 줄인다.
- URL 리디렉션(redirection): 축약된 URL로 HTTP 요청이 오면 원래 URL로 redirection한다.
- 높은 가용성과 규모 확장성, 그리고 장애 감내가 요구됨.

### API 리디렉션(redirection)

흔히 리디렉션을 위해 브라우저에 HTTP 301 상태 코드와 Location 헤더에 리디렉션할 URL을 응답한다.

**여기서 301 대신에 302도 활용할 수 있는데, 이 둘의 차이는 다음과 같고 적절한 상황에 선택하여 활용하자.**

- `301 Permanently Moved`
  - 이 응답은 영구적으로 URL이 이전되었다는 응답이다. 따라서 Location 헤더로 반환한 URL을 브라우저는 캐시(cache)하게 된다.
  - 따라서 서버의 부하를 줄일 수 있다.
- `302 Found`
  - 이 응답은 301과 달리 `일시적`으로 URL이 이전되었다는 응답이다. 따라서 301과 달리 브라우저는 URL을 캐시하지 않는다.
  - 이렇게하면 매번 URl 단축기에 브라우저가 요청을 보내므로 트래픽 분석 등 데이터 분석에 활용해볼 수 있다.

### URl 단축

단축 URL을 만드는 방법은 해시 함수를 이용한다.

결국 중요한 것은 긴 URL을 해시 값으로 대응시킬 수 있는 함수 fx를 찾는 것이다.

해시 함수는 다음 요구사항을 만족해야한다.

- 입력으로 주어진 긴 URL이 다른 값이면 해시 값도 달라야 함
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야함

### 해시 함수

URL 단축기에서는 해시 함수를 적절히 설정하는 것이 중요하다.

해시 함수가 계산한 단축 URL 값을 `hashValue`라고 칭하면,

`hashValue`는 [0-9, a-z, A-Z]의 문자들로 구성될 수 있을 것이다.
이는 10 + 26 + 26 = 총 62개의 문자를 사용할 수 있다는 걸 의미하고 따라서 hashValue의 길이에 따라 62^n개의 URL을 수용할 수 있게된다. 여기서 n의 값은 시스템 요구사항에 맞게 결정된다.

이 글에서는 n을 7로 잡고 약 3.5조 개의 URL을 수용할 수 있는 시스템 기준으로 얘기할 것이다.

이어서 해시 함수 구현에 쓰일 기술인 `해시 후 충돌 해소` 와 `base-62 변환법` 을 알아보자

### 해시 후 충돌 해소

긴 URL을 줄이려면 원래 URL을 줄이는 해시 함수가 필요하다.

손쉬운 방법은 세간에 잘 알려진 CRC32, MD5, SHA-1같은 해시 함수를 이용하는 것인데,

**이 함수들로 생성된 문자열은 7글자를 초과하기에 위에서 정한 n=7을 만족할 수 없다**

그래서 단순하게는 해시 값에서 처음 7개만 사용하는 방법이 있겠지만
→ 이는 충돌 확률이 높아진다.

이럴 때 충돌이 해소될 때까지 사전에 정한 `문자열을 덧붙여 충돌을 해소`할 수 있다

하지만 이 방법은 충돌 여부 파악을 위해 한 번 이상 DB에 쿼리를 해야하므로 오버헤드가 크다.

따라서 DB대신에 `블룸 필터`를 이용해볼 수 있다.

- `블룸 필터`
  - 어떤 집합에 특정 원소가 있는지 검사할 수 있도록 하는 확률론에 기초한 기술
  - 공간 효율이 좋음

### base-62 변환

진법 변환(base conversiond)은 URL 단축기를 구현할 때 흔히 사용되는 접근법 중 하나이며
수의 표현 방식이 다른 두 시스템이 같은 수를 공유하여야 하는 경우 유용하다.

추가로 62진법을 쓰는 이유는 hashValue에서 표현가능한 문자 수가 62개이기 때문이다.

- 단 이 경우 `유일성 보장 ID 생성기`가 별도로 필요하다

### 해시 후 충돌 해소 vs base-62 변환

`해시 후 충돌 해소`와 `base-62` 는 각각의 장단점이 있어 트레이드오프가 필요하다

아래 장단점을 비교하여 상황에 맞는 적절한 선택을 하자

| 해시 후 충돌 해소 전략 | base-62 변환 |
| --- | --- |
| 단축 URL의 길이가 고정됨 | 단축 URL의 길이가 ID 값에 따라 가변적 |
| 유일 ID 생성기 필요 X | 유일 ID 생성기 필요 O |
| 충돌 가능 = 충돌 해소 전략 필요 | ID 유일성이 보장된 후에 적용할 수 있으므로 이론상 충돌 불가능 |
| ID로 부터 URL을 계산하는 방식이 아니므로 다음에 쓸 수 있는 URL 유추 불가능 | ID가 1씩 증가하는 값이라고 가정하면 다음 URL을 쉽게 알아낼 수 있어 보안 문제 존 |

### 마치며

위에서 알아본 내용을 바탕으로 URL 단축기를 설계해볼 수 있을 것 같다.

면접에서 설계를 마친 이후 시간이 남는다면 다음 논의들을 해보자

- `처리율 제한 장치`(rate limiter)
  - 엄청난 양의 URL 단축 요청이 밀려들 경우 URL 단축기 시스템이 무력화될 수 있다.
  - IP 주소를 비롯한 필터링 규칙으로 요청을 걸러내보자
- `웹 서버의 규모 확장`
  - 웹 계층은 무상태 계층이므로 자유로이 증설/삭제 가능하다
- `데이터베이스 규모 확장`
  - 데이터베이스를 다중화하거나 샤딩하여 규모 확장을 해볼 수 있다
- `데이터 분석 솔루션`
  - 비즈니스 성장을 위해 데이터는 중요하다
  - URL 단축기에 대해서 어떤 링크를 얼마나 많은 사용자가 클릭하는지 중요한 지표들을 알아볼 수 있다
- `가용성`, `데이터 일관성`, `안정성`
  - 안정적인 대규모 시스템을 위한 필수 요소인 가용성, 데이텅
