- [안정 해시](#안정-해시)
  - [해시 공간과 해시 링](#해시-공간과-해시-링)
  - [해시링에서의 서버 조회](#해시링에서의-서버-조회)
  - [서버 추가와 삭제](#서버-추가와-삭제)
  - [가상 노드를 활용한 균등 분포](#가상-노드를-활용한-균등-분포)
  - [note. 안정 해시의 이점과 사용 사례](#note-안정-해시의-이점과-사용-사례)

# 안정 해시

수평적 규모 확정성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. `안정 해시`는 이 목표를 달성하기 위해 보편적으로 사용하는 기술이다.

일반적으로 데이터를 분배할 때,
4개의 서버가 있다면 ID 값을 4로 나눈 나머지 값을 기준으로 데이터를 분배해볼 수 있을 것 같다.
하지만 이렇게 하면 서비스 규모에 따라 서버를 추가하거나 삭제할 때 해시 키를 재배치해야하는 문제가 발생한다.

안정 해시를 활용하면 이런 해시 재배치 문제를 해결할 수 있다.

- 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술
- k는 키의 개수, n은 슬롯(slot)의 개수
- 이와는 달리 대부분의 전통적 해시 테이블은 슬롯의 수가 바뀜녀 거의 대부분의 키를 재배치한다.

## 해시 공간과 해시 링

해시 값에 따라 분배한 해시 공간을 1차원 배열로 나타낼 수 있는데 이 1차원 배열의 양 끝점을 구부려 링 형태로 하면 해시 링(hash ring)이 만들어진다.

![hash-array](https://user-images.githubusercontent.com/72328687/193533053-05c7ad1a-a873-478a-ab2e-3f4a12e925e3.png)

![hash-ring](https://user-images.githubusercontent.com/72328687/193533055-1de84b8f-68e4-4c1f-9500-411839299c15.png)

## 해시링에서의 서버 조회

어떤 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버가 된다

![find-server-in-hash-ring](https://user-images.githubusercontent.com/72328687/193533052-e245a699-919b-417d-8304-b69615ad7d90.png)

## 서버 추가와 삭제

해시 링에서 서버를 추가할 때는 키 가운데 일부만 재배치하면 된다.

- key0 → server0 로 배치되어있던 구조에서
- key0 → server4 → server0 으로 변경된다면
- server0을 가리키던 key값만 server6으로 변경하면 된다.
- 삭제도 이와 유사하고 일부 키만 재배치한다.

![add-server-to-hash-ring](https://user-images.githubusercontent.com/72328687/193533046-958a6a6b-3943-435d-8188-d5d354f30de8.png)

## 가상 노드를 활용한 균등 분포

지금까지 알아본 방식으로는 특정 서버는 굉장히 큰 해시 공간을 차지하거나 어떤 서버는 데이터를 아무것도 갖지 않는 경우도 생길 수 있는데, 이를 `가상 노드`(Virtual Node)를 사용해서 해결해볼 수 있다

- 가상 노드(Virtual Node)
  - 가상 노드란 실제 노드 또는 서버를 가리키는 노드(일종의 포인터)로 하나의 서버는 링 위에서 여러 개의 가상 노드를 가질 수 있다.
  - 가상 노드의 개수를 늘리면 데이터가 어떻게 퍼져있는지 나타내는 표준 편차(standard deviation)가 작아져서 키의 분포가 점점 더 균등해지게 된다.
  - 가상 노드를 늘릴 수록 표준 편차는 줄어들고 대신에 비용이 증가하므로 tradeoff를 잘 고려하여 적절히 조정하는 것이 중요하다.
  - 이를 이미지로 살펴보면 다음과 같다.

![virtual-node-in-hash-ring](https://user-images.githubusercontent.com/72328687/193533058-85861186-3469-45a2-8f34-928420900176.png)

## note. 안정 해시의 이점과 사용 사례

안정 해시의 이점을 정리해보면 다음과 같다.

- 서버가 추가되거나 삭제될 때 재배치되는 키의 수를 최소화 한다.
- 데이터가 보다 균등하게 분포되므로 수평적 규모 확장성을 달성하기 쉽다
- 핫스팟(hotspot) 키 문제를 줄인다.

안정 해시 사용 사례

- AWS DynamoDB의 파티셔닝 관련 컴포넌트
- Apache Cassandra 클러스터에서의 데이터 파티셔닝
- Discord 채팅 application
- 아카마이(Akamai) CDN
- 매그레프(Meglev) 네트워크 부하 분산기
